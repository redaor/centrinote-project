<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentification Zoom BFF - Solution D√©finitive</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 14px;
        }
        
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }

        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test Authentification Zoom BFF - Solution D√©finitive</h1>
        <p>Pattern Backend-for-Frontend avec domaine <strong>zoomapp.local</strong> pour r√©soudre l'erreur 4700 Zoom.</p>
        
        <div class="highlight">
            <h4>üéØ Solution Impl√©ment√©e</h4>
            <ul>
                <li><strong>‚úÖ Domaine local:</strong> zoomapp.local au lieu de localhost</li>
                <li><strong>‚úÖ Architecture BFF:</strong> Sessions c√¥t√© serveur, pas localStorage</li>
                <li><strong>‚úÖ OAuth direct:</strong> Zoom redirige vers backend uniquement</li>
                <li><strong>‚úÖ CORS configur√©:</strong> Support domaine zoomapp.local</li>
            </ul>
        </div>
        
        <div id="status" class="status info">
            Chargement BFF...
        </div>
        
        <div class="test-section">
            <h3>üéØ √âtat d'authentification BFF</h3>
            <div id="auth-status"></div>
            <div id="user-info"></div>
        </div>
        
        <div class="test-section">
            <h3>‚ö° Actions BFF</h3>
            <button id="check-status-btn" onclick="checkSessionStatus()">V√©rifier Session BFF</button>
            <button id="start-oauth-btn" onclick="startOAuthBFF()">D√©marrer OAuth Zoom BFF</button>
            <button id="logout-btn" onclick="logoutBFF()" disabled>D√©connexion BFF</button>
        </div>
        
        <div class="test-section">
            <h3>üß™ Tests API BFF</h3>
            <button id="test-session-btn" onclick="testSession()">Tester /auth/session</button>
            <button id="test-meetings-btn" onclick="testMeetings()" disabled>Tester /api/meetings</button>
            <div id="api-results"></div>
        </div>
        
        <div class="test-section">
            <h3>üìã Logs BFF</h3>
            <div id="logs" style="height: 250px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
            </div>
        </div>
    </div>

    <!-- Inclure le helper BFF -->
    <script src="frontend-auth-helper-bff.js"></script>
    
    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            
            if (logs.length > 100) {
                logs = logs.slice(-100);
            }
            
            document.getElementById('logs').innerHTML = logs.join('\n');
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
            
            console.log(`[BFF ${type}] ${message}`);
        }
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateAuthStatus() {
            const isAuth = window.zoomAuthBFF.isAuthenticated();
            const user = window.zoomAuthBFF.getUser();
            
            const authStatusEl = document.getElementById('auth-status');
            const userInfoEl = document.getElementById('user-info');
            
            if (isAuth && user) {
                authStatusEl.innerHTML = '<div class="success">‚úÖ Session BFF Authentifi√©e</div>';
                userInfoEl.innerHTML = `
                    <div class="user-info">
                        <strong>üë§ Utilisateur BFF connect√©:</strong><br>
                        <strong>ID:</strong> ${user.id}<br>
                        <strong>Email:</strong> ${user.email}<br>
                        <strong>Nom:</strong> ${user.displayName}<br>
                        <strong>Compte ID:</strong> ${user.accountId}<br>
                        <strong>Authentifi√© le:</strong> ${new Date(user.authenticatedAt).toLocaleString()}
                    </div>
                `;
                
                document.getElementById('logout-btn').disabled = false;
                document.getElementById('test-meetings-btn').disabled = false;
                document.getElementById('start-oauth-btn').disabled = true;
            } else {
                authStatusEl.innerHTML = '<div class="error">‚ùå Session BFF Non Authentifi√©e</div>';
                userInfoEl.innerHTML = '';
                
                document.getElementById('logout-btn').disabled = true;
                document.getElementById('test-meetings-btn').disabled = true;
                document.getElementById('start-oauth-btn').disabled = false;
            }
        }
        
        async function checkSessionStatus() {
            try {
                log('üîç V√©rification session BFF...', 'info');
                const user = await window.zoomAuthBFF.checkAuthStatus();
                
                if (user) {
                    log(`‚úÖ Session BFF valide: ${user.email}`, 'success');
                    updateStatus('Session BFF authentifi√©e', 'success');
                } else {
                    log('‚ùå Session BFF non authentifi√©e', 'warning');
                    updateStatus('Session BFF non authentifi√©e', 'warning');
                }
                
                updateAuthStatus();
            } catch (error) {
                log(`‚ùå Erreur v√©rification session BFF: ${error.message}`, 'error');
                updateStatus('Erreur v√©rification BFF', 'error');
                updateAuthStatus();
            }
        }
        
        async function startOAuthBFF() {
            try {
                log('üöÄ D√©marrage OAuth BFF avec zoomapp.local...', 'info');
                updateStatus('Redirection vers Zoom OAuth BFF...', 'info');
                await window.zoomAuthBFF.startOAuth();
            } catch (error) {
                log(`‚ùå Erreur OAuth BFF: ${error.message}`, 'error');
                updateStatus('Erreur OAuth BFF', 'error');
            }
        }
        
        async function logoutBFF() {
            try {
                log('üîÑ D√©connexion BFF...', 'info');
                await window.zoomAuthBFF.logout();
                log('‚úÖ D√©connexion BFF r√©ussie', 'success');
                updateStatus('D√©connect√© BFF', 'success');
                updateAuthStatus();
            } catch (error) {
                log(`‚ùå Erreur d√©connexion BFF: ${error.message}`, 'error');
                updateStatus('Erreur d√©connexion BFF', 'error');
            }
        }
        
        async function testSession() {
            try {
                log('üß™ Test endpoint /auth/session BFF...', 'info');
                const response = await fetch('http://zoomapp.local:5174/auth/session', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                document.getElementById('api-results').innerHTML = `
                    <h4>R√©sultat /auth/session BFF:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                if (data.success && data.authenticated) {
                    log('‚úÖ Test session BFF r√©ussi', 'success');
                } else {
                    log(`‚ùå Test session BFF: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur test session BFF: ${error.message}`, 'error');
                document.getElementById('api-results').innerHTML = `
                    <h4>Erreur /auth/session BFF:</h4>
                    <pre>${error.message}</pre>
                `;
            }
        }
        
        async function testMeetings() {
            try {
                log('üß™ Test endpoint /api/meetings BFF...', 'info');
                const response = await window.zoomAuthBFF.authenticatedFetch('/api/meetings');
                const data = await response.json();
                
                document.getElementById('api-results').innerHTML = `
                    <h4>R√©sultat /api/meetings BFF:</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                if (data.success || data.meetings) {
                    log('‚úÖ Test meetings BFF r√©ussi', 'success');
                } else {
                    log(`‚ùå Test meetings BFF: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur test meetings BFF: ${error.message}`, 'error');
                document.getElementById('api-results').innerHTML = `
                    <h4>Erreur /api/meetings BFF:</h4>
                    <pre>${error.message}</pre>
                `;
            }
        }
        
        // Diagnostic serveur BFF
        async function diagnoseBFF() {
            try {
                log('üîß Diagnostic serveur BFF zoomapp.local...', 'info');
                
                const healthResponse = await fetch('http://zoomapp.local:5174/health');
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    log(`‚úÖ Serveur BFF zoomapp.local op√©rationnel`, 'success');
                    log(`üìä Config: Zoom=${healthData.zoom_configured}, Env=${healthData.environment}`, 'info');
                    return true;
                } else {
                    log(`‚ùå Serveur BFF erreur: ${healthResponse.status}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Serveur BFF inaccessible: ${error.message}`, 'error');
                log('üí° V√©rifiez: 1) /etc/hosts contient "127.0.0.1 zoomapp.local" 2) serveur sur port 5174', 'warning');
                return false;
            }
        }
        
        // Gestionnaires d'√©v√©nements BFF
        window.addEventListener('zoom-auth-bff-success', (event) => {
            log(`üéâ Authentification BFF r√©ussie: ${event.detail.email}`, 'success');
            updateStatus('Authentification Zoom BFF r√©ussie !', 'success');
            updateAuthStatus();
        });
        
        window.addEventListener('zoom-auth-bff-error', (event) => {
            log(`‚ùå Erreur authentification BFF: ${event.detail}`, 'error');
            updateStatus(`Erreur authentification BFF: ${event.detail}`, 'error');
            updateAuthStatus();
        });
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            log('üöÄ Interface de test BFF initialis√©e avec zoomapp.local', 'info');
            updateStatus('Interface BFF pr√™te', 'info');
            
            // Diagnostic automatique
            const bffOk = await diagnoseBFF();
            
            if (bffOk) {
                updateStatus('Serveur BFF zoomapp.local OK', 'success');
                updateAuthStatus();
                
                // V√©rification session apr√®s petit d√©lai
                setTimeout(checkSessionStatus, 1000);
            } else {
                updateStatus('Serveur BFF zoomapp.local non accessible', 'error');
                log('üö® Impossible de continuer sans serveur BFF zoomapp.local', 'error');
            }
        });
    </script>
</body>
</html>